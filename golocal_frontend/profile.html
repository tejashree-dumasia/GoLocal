<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoLocal - My Profile</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container { max-width: 600px; }
        .profile-card { padding: 2rem; }
        .error-message { text-align: center; }
        .action-buttons button { margin-right: 10px; }
        /* --- NEW STYLES --- */
        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #eee;
            display: block;
            margin: 0 auto 1.5rem auto;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <div id="profile-view" class="card profile-card" style="display: none;">
        
        <img src="https://via.placeholder.com/150" alt="Profile Picture" class="profile-picture" id="profile-pic-img">

        <form id="upload-pic-form" class="mb-4">
            <div class="form-group">
                <label for="profile-picture-file">Change Profile Picture</label>
                <input type="file" class="form-control-file" id="profile-picture-file" name="profile_picture" required>
            </div>
            <button type="submit" class="btn btn-sm btn-outline-primary">Upload</button>
            <div id="upload-response" class="mt-2"></div>
        </form>
        <h2 class="card-title mb-4" id="profile-username-title">My Profile</h2>
        <dl class="row">
            <dt class="col-sm-3">User ID:</dt>
            <dd class="col-sm-9" id="user-id"></dd>
            <dt class="col-sm-3">Username:</dt>
            <dd class="col-sm-9" id="user-username"></dd>
            <dt class="col-sm-3">Email:</dt>
            <dd class="col-sm-9" id="user-email"></dd>
        </dl>
        <div class="action-buttons mt-4">
            <button id="edit-profile-btn" class="btn btn-info" data-toggle="modal" data-target="#editProfileModal">Edit Username</button>
            <button id="delete-account-btn" class="btn btn-danger">Delete Account</button>
            <button id="logout-button" class="btn btn-secondary float-right">Logout</button>
        </div>
        <div id="action-response" class="alert mt-3" style="display: none;"></div>
    </div>

    <div id="error-view" class="alert alert-danger error-message" style="display: none;">
        <h4>Access Denied</h4>
        <p>You must be logged in to view this page. Please <a href="login-test.html">login here</a>.</p>
    </div>
</div>

<div class="modal fade" id="editProfileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-username">New Username</label>
                        <input type="text" class="form-control" id="edit-username" required>
                    </div>
                </form>
                <div id="edit-response" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-profile-btn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function() {
    // API Endpoints
    var readApiUrl = 'http://127.0.0.1:8000/api/users/read_single';
    var updateApiUrl = 'http://127.0.0.1:8000/api/users/update';
    var deleteApiUrl = 'http://127.0.0.1:8000/api/users/delete';
    var uploadApiUrl = 'http://127.0.0.1:8000/api/users/upload_profile'; // <-- NEW

    var jwt = localStorage.getItem('jwt');
    var currentUser = null;

    if (!jwt) {
        $('#error-view').show();
        $('#profile-view').hide();
        return;
    }

    function fetchUserProfile() {
        $.ajax({
            url: readApiUrl,
            type: 'GET',
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + jwt); },
            success: function(response) {
                currentUser = response; 
                $('#user-id').text(currentUser.user_id);
                $('#user-username').text(currentUser.username);
                $('#user-email').text(currentUser.email);
                $('#edit-username').val(currentUser.username);
                $('#profile-username-title').text(currentUser.username + "'s Profile"); // <-- NEW

                // --- NEW: Set Profile Picture ---
                if (response.profile_picture_url) {
                    $('#profile-pic-img').attr('src', response.profile_picture_url);
                }
                
                $('#profile-view').show();
                $('#error-view').hide();
            },
            error: function(jqXHR) {
                // ... (existing error handling)
            }
        });
    }

    // --- NEW: Event Listener for Profile Picture Upload ---
    $('#upload-pic-form').on('submit', function(e) {
        e.preventDefault();
        
        var fileInput = $('#profile-picture-file')[0];
        if (fileInput.files.length === 0) {
            alert('Please select a file to upload.');
            return;
        }

        var formData = new FormData();
        formData.append('profile_picture', fileInput.files[0]);
        formData.append('jwt', jwt); // Send JWT in the form data

        var uploadResponseDiv = $('#upload-response');
        uploadResponseDiv.text('Uploading...').removeClass('text-danger text-success').show();

        $.ajax({
            url: uploadApiUrl,
            type: 'POST',
            data: formData,
            contentType: false, // Required for FormData
            processData: false, // Required for FormData
            success: function(response) {
                uploadResponseDiv.text(response.message).removeClass('text-danger').addClass('text-success');
                $('#profile-pic-img').attr('src', response.filePath); // Update image on success
                setTimeout(function() { uploadResponseDiv.hide().text(''); }, 3000);
            },
            error: function(jqXHR) {
                var errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : 'Upload failed.';
                uploadResponseDiv.text(errorMsg).removeClass('text-success').addClass('text-danger');
            }
        });
    });

    // --- Event Listener for Save Profile Changes ---
    $('#save-profile-btn').on('click', function() {
        // ... (existing save profile logic)
    });

    // --- Event Listener for Delete Account ---
    $('#delete-account-btn').on('click', function() {
        // ... (existing delete account logic)
    });

    // --- Event Listener for Logout ---
    $('#logout-button').on('click', function() {
        // ... (existing logout logic)
    });

    // --- Initial Load ---
    fetchUserProfile();
});
</script>

</body>
</html>
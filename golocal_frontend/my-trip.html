<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoLocal - My Trips</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .trip-card-link {
            color: inherit;
            text-decoration: none;
        }
        .trip-card-link:hover {
            text-decoration: none;
        }
        .trip-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .trip-card { 
            margin-bottom: 1.5rem;
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>My Adventures üó∫Ô∏è</h2>
        <a href="create-trip.html" class="btn btn-primary">Plan a New Trip</a>
    </div>

    <div id="trips-container" class="row">
        </div>

    <div id="error-view" class="alert alert-danger" style="display: none;">
        <h4>Access Denied</h4>
        <p>You must be logged in to view your trips. Please <a href="login-test.html">login here</a>.</p>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
// --- NEW HELPER FUNCTION ---
// Decodes the JWT to get the user's ID
function getUserIdFromJwt(token) {
    try {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload).data.id;
    } catch (e) {
        return null;
    }
}

$(document).ready(function() {
    var readApiUrl = 'http://api.golocal.test/api/trips/read';
    // --- NEW API URL ---
    var deleteApiUrl = 'http://api.golocal.test/api/trips/delete';
    var jwt = localStorage.getItem('jwt');

    if (!jwt) {
        $('#error-view').show();
        return;
    }

    // --- NEW: Get the current user's ID ---
    var currentUserId = getUserIdFromJwt(jwt);

    $.ajax({
        url: readApiUrl,
        type: 'GET',
        beforeSend: function(xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + jwt);
        },
        
        success: function(response) {
            var tripsContainer = $('#trips-container');
            if (response.records && response.records.length > 0) {
                $.each(response.records, function(index, trip) {
                    
                    // --- NEW: Conditionally create a delete button ---
                    var deleteButton = '';
                    if (trip.admin_id == currentUserId) {
                        deleteButton = `<button class="btn btn-sm btn-outline-danger float-right delete-trip-btn" data-id="${trip.trip_id}">Delete</button>`;
                    }

                    // --- UPDATED tripCard template ---
                    var tripCard = `
                        <div class="col-md-6" id="trip-card-${trip.trip_id}">
                            <div class="card trip-card">
                                <div class="card-body">
                                    ${deleteButton}
                                    <h5 class="card-title">
                                        <a href="trip-detail.html?id=${trip.trip_id}" class="trip-card-link">${trip.trip_name}</a>
                                    </h5>
                                    <h6 class="card-subtitle mb-2 text-muted">${trip.location}</h6>
                                    <p class="card-text">
                                        <strong>Starts:</strong> ${new Date(trip.start_datetime).toLocaleString('en-IN')}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    tripsContainer.append(tripCard);
                });
            } else {
                tripsContainer.html('<div class="col"><div class="alert alert-info">You haven\'t planned any trips yet. Why not start a new adventure?</div></div>');
            }
        },
        error: function(jqXHR) {
            $('#error-view').show();
        }
    });

    // --- NEW: Event listener for the delete button ---
    $(document).on('click', '.delete-trip-btn', function(e) {
        e.preventDefault(); // Stop it from triggering any other links
        
        if (!confirm('Are you sure you want to permanently delete this trip? This will also delete all participants, chat messages, and photos.')) {
            return;
        }

        var tripId = $(this).data('id');
        var cardToRemove = $(`#trip-card-${tripId}`);

        $.ajax({
            url: deleteApiUrl,
            type: 'POST', // Using POST to send a JSON body
            contentType: 'application/json',
            data: JSON.stringify({ jwt: jwt, trip_id: tripId }),
            success: function(response) {
                alert(response.message);
                cardToRemove.remove(); // Remove the card from the page
            },
            error: function(jqXHR) {
                alert(jqXHR.responseJSON.message);
            }
        });
    });
});
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoLocal - Trip Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>

<div class="container mt-5">
    <div id="trip-details-container">
        <h2 id="trip-name">Loading Trip...</h2>
        <p class="text-muted" id="trip-location"></p>
        <hr>
        <p id="trip-description"></p>
        <div class="row">
            <div class="col-md-6">
                <strong>Starts:</strong> <span id="trip-start"></span>
            </div>
            <div class="col-md-6">
                <strong>Ends:</strong> <span id="trip-end"></span>
            </div>
            <div class="col-md-6 mt-2">
                <strong>Estimated Cost:</strong> â‚¹<span id="trip-cost"></span>
            </div>
        </div>
    </div>
    
    <div class="mt-5">
        <h4>Participants</h4>
        <ul id="participants-list" class="list-group">
        </ul>
    </div>

    <div id="add-participant-section" class="card mt-4" style="display: none;">
        <div class="card-header">
            <h5>Add Participants</h5>
        </div>
        <div class="card-body">
            <form id="add-participant-form">
                <p>Invite friends with a GoLocal account, or add anyone by email or name for planning.</p>
                <div class="form-group">
                    <label for="participant-email">Participant's Email (optional)</label>
                    <input type="email" class="form-control" id="participant-email" placeholder="friend@example.com">
                </div>
                <div class="form-group">
                    <label for="participant-name">Participant's Name</label>
                    <input type="text" class="form-control" id="participant-name" placeholder="e.g., Arun from Pune">
                </div>
                <button type="submit" class="btn btn-primary">Add to Trip</button>
            </form>
            <div id="invite-response" class="mt-3"></div>
        </div>
    </div>


        <div id="error-view" class="alert alert-danger mt-4" style="display: none;"></div>

        <!-- Edit Participant Modal -->
        <div class="modal fade" id="editParticipantModal" tabindex="-1" role="dialog" aria-labelledby="editParticipantModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <form id="edit-participant-form" class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editParticipantModalLabel">Edit Participant</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-participant-id">
                        <div class="form-group">
                            <label for="edit-participant-name">Name</label>
                            <input type="text" class="form-control" id="edit-participant-name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-participant-email">Email</label>
                            <input type="email" class="form-control" id="edit-participant-email">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="edit-participant-coadmin"> Co-Admin
                            </label>
                        </div>
                        <div id="edit-response" class="mt-2"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
$(document).ready(function() {
    // --- SETUP ---
    var jwt = localStorage.getItem('jwt');
    var urlParams = new URLSearchParams(window.location.search);
    var tripId = urlParams.get('id');
    var isAdmin = false; // This will be set after fetching trip details

    // --- UPDATED & CONSISTENT API Endpoints ---
    var tripDetailApiUrl = `http://api.golocal.local/api/trips/read_single?id=${tripId}`;
    var participantsApiUrl = `http://api.golocal.local/api/trips/read_participants?id=${tripId}`;
    var inviteApiUrl = `http://api.golocal.local/api/trips/invite`;
    var updateApiUrl = `http://api.golocal.local/api/trips/update_participant`;
    var deleteApiUrl = `http://api.golocal.local/api/trips/delete_participant`;
    
    // If no JWT or tripId, show an error and stop
    if (!jwt || !tripId) {
        showError('Access Denied or invalid trip ID.');
        $('.container > div:not(#error-view)').hide(); // Hide all other sections
        return;
    }

    // --- ERROR HANDLING FUNCTION ---
    function showError(message) {
        $('#error-view').text(message).show();
        setTimeout(function() { $('#error-view').fadeOut(); }, 2000);
    }

    // --- FUNCTION TO FETCH TRIP DETAILS ---
    function fetchTripDetails() {
        $.ajax({
            url: tripDetailApiUrl,
            type: 'GET',
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + jwt); },
            success: function(trip) {
                $('#trip-name').text(trip.trip_name);
                $('#trip-location').text(trip.location);
                $('#trip-description').text(trip.description);
                $('#trip-start').text(new Date(trip.start_datetime).toLocaleString('en-IN'));
                $('#trip-end').text(new Date(trip.end_datetime).toLocaleString('en-IN'));
                $('#trip-cost').text(trip.estimated_cost || 'N/A');

                // Defensive: check is_admin is boolean or 0/1
                isAdmin = (trip.is_admin === true || trip.is_admin === 1 || trip.is_admin === '1');
                if (isAdmin) {
                    $('#add-participant-section').show();
                } else {
                    $('#add-participant-section').hide();
                }

                fetchParticipants(); // Fetch participants after we know the admin status
            },
            error: function(jqXHR) {
                var errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : "Could not load trip details.";
                showError(errorMsg);
            }
        });
    }

    // --- FUNCTION TO FETCH PARTICIPANTS ---
    function fetchParticipants() {
        $.ajax({
            url: participantsApiUrl,
            type: 'GET',
            beforeSend: function(xhr) { xhr.setRequestHeader('Authorization', 'Bearer ' + jwt); },
            success: function(response) {
                var list = $('#participants-list');
                list.empty();
                if (response.records && response.records.length > 0) {
                    $.each(response.records, function(i, participant) {
                        var participantName = participant.guest_name || 'Unnamed Participant';
                        var participantDetail = participant.guest_email || `Registered User (ID: ${participant.user_id})`;
                        var coAdminLabel = participant.is_co_admin == 1 ? '<span class="badge badge-info ml-2">Co-Admin</span>' : '';
                        var adminControls = '';
                        if (isAdmin) {
                            adminControls = `
                                <button class="btn btn-sm btn-outline-secondary edit-btn ml-2"
                                    data-id="${participant.participant_id}"
                                    data-name="${participant.guest_name}"
                                    data-email="${participant.guest_email || ''}"
                                    data-coadmin="${participant.is_co_admin == 1 ? '1' : '0'}">
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn ml-2" data-id="${participant.participant_id}">Delete</button>
                            `;
                        }
                        list.append(`<li class="list-group-item">
                            ${participantName} <small class="text-muted">(${participant.status})</small> ${coAdminLabel} <br>
                            <small>${participantDetail}</small>
                            ${adminControls}
                        </li>`);
                    });
                } else {
                    list.append('<li class="list-group-item">No participants have been added yet.</li>');
                }
            },
            error: function(jqXHR) {
                var errorMsg = jqXHR.responseJSON && jqXHR.responseJSON.error
                    ? jqXHR.responseJSON.error
                    : (jqXHR.responseJSON && jqXHR.responseJSON.message ? jqXHR.responseJSON.message : 'Could not load participants.');
                showError(errorMsg);
            }
        });
    }

    // --- EVENT HANDLER FOR DELETING PARTICIPANTS ---
    $(document).on('click', '.delete-btn', function() {
        if (!confirm('Are you sure you want to remove this participant?')) return;

        var participantId = $(this).data('id');
        var requestData = {
            jwt: jwt,
            participant_id: participantId
        };
        $.ajax({
            url: deleteApiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData),
            success: function(response) {
                showError(response.message); // Use error-view for all messages
                fetchParticipants(); // Refresh the list
            },
            error: function(jqXHR) {
                var errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : "Could not remove participant.";
                showError(errorMsg);
            }
        });
    });

    // --- EVENT HANDLER FOR EDITING PARTICIPANTS ---
    $(document).on('click', '.edit-btn', function() {
        $('#edit-participant-id').val($(this).data('id'));
        $('#edit-participant-name').val($(this).data('name'));
        $('#edit-participant-email').val($(this).data('email'));
        $('#edit-participant-coadmin').prop('checked', $(this).data('coadmin') == '1');
        $('#edit-response').empty();
        $('#editParticipantModal').modal('show');
    });

    // --- EVENT HANDLER FOR SUBMITTING EDIT PARTICIPANT FORM ---
    $('#edit-participant-form').on('submit', function(e) {
        e.preventDefault();
        var participantId = $('#edit-participant-id').val();
        var name = $('#edit-participant-name').val();
        var email = $('#edit-participant-email').val();
        var isCoAdmin = $('#edit-participant-coadmin').is(':checked') ? 1 : 0;

        var updateData = {
            jwt: jwt,
            participant_id: participantId,
            name: name,
            email: email,
            is_co_admin: isCoAdmin
        };

        $.ajax({
            url: updateApiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(updateData),
            success: function(response) {
                $('#edit-response').html('<div class="alert alert-success">' + response.message + '</div>');
                setTimeout(function() {
                    $('#editParticipantModal').modal('hide');
                    fetchParticipants();
                }, 1000);
            },
            error: function(jqXHR) {
                var errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.message : "Could not update participant.";
                $('#edit-response').html('<div class="alert alert-danger">' + errorMsg + '</div>');
                showError(errorMsg);
            }
        });
    });
    
    // --- EVENT HANDLER FOR ADDING PARTICIPANTS ---
    $('#add-participant-form').on('submit', function(event) {
        event.preventDefault();

        var inviteData = {
            jwt: jwt,
            trip_id: tripId,
            email: $('#participant-email').val(),
            name: $('#participant-name').val()
        };

        $.ajax({
            url: inviteApiUrl,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(inviteData),
            success: function(response) {
                $('#invite-response').html('<div class="alert alert-success">' + response.message + '</div>');
                $('#add-participant-form')[0].reset();
                fetchParticipants(); // Refresh the participant list
            },
            error: function(jqXHR) {
                var errorMessage = jqXHR.responseJSON ? jqXHR.responseJSON.message : 'An error occurred.';
                $('#invite-response').html('<div class="alert alert-danger">' + errorMessage + '</div>');
                showError(errorMessage);
            }
        });
    });

    // --- INITIAL PAGE LOAD ---
    fetchTripDetails();
});
</script>

</body>
</html>
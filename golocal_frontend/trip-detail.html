<!DOCTYPE html>
<html lang="en" ng-app="GoLocalApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoLocal - Trip Details</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
</head>
<body ng-controller="TripDetailController">
<div class="container mt-5">
    <div id="trip-details-container">
        <h2>{{ trip.trip_name || 'Loading Trip...' }}</h2>
        <p class="text-muted">{{ trip.location }}</p>
        <hr>
        <p>{{ trip.description }}</p>
        <div class="row">
            <div class="col-md-6">
                <strong>Starts:</strong> <span>{{ trip.start_datetime && (trip.start_datetime | date:'medium') }}</span>
            </div>
            <div class="col-md-6">
                <strong>Ends:</strong> <span>{{ trip.end_datetime && (trip.end_datetime | date:'medium') }}</span>
            </div>
            <div class="col-md-6 mt-2">
                <strong>Estimated Cost:</strong> â‚¹<span>{{ trip.estimated_cost || 'N/A' }}</span>
            </div>
        </div>
    </div>
    <div class="mt-5">
        <h4>Participants</h4>
        <ul class="list-group">
            <li class="list-group-item" ng-repeat="participant in participants">
                {{ getParticipantName(participant) }} <small class="text-muted">({{ participant.status }})</small>
                <span ng-if="participant.user_id == adminId" class="badge badge-primary ml-2">Admin</span>
                <span ng-if="participant.user_id == coAdminId && participant.user_id != adminId" class="badge badge-info ml-2">Co-Admin</span>
                <br>
                <button ng-if="canShowMakeCoAdmin(participant)" class="btn btn-sm btn-outline-secondary ml-2" ng-click="makeCoAdmin(participant.user_id)">Make Co-Admin</button>
                <button ng-if="canShowDelete(participant)" class="btn btn-sm btn-outline-danger ml-2" ng-click="deleteParticipant(participant.participant_id)">Delete</button>
            </li>
            <li class="list-group-item" ng-if="participants.length === 0">No participants have been added yet.</li>
        </ul>
    </div>
    <div class="card mt-4" ng-show="isAdmin">
        <div class="card-header">
            <h5>Add Participant</h5>
        </div>
        <div class="card-body">
            <form ng-submit="inviteParticipant()">
                <p>Invite a participant by their registered GoLocal email address.</p>
                <div class="form-group">
                    <label for="participant-email">Participant's Email</label>
                    <input type="email" class="form-control" id="participant-email" ng-model="inviteEmail" placeholder="friend@example.com" required>
                </div>
                <button type="submit" class="btn btn-primary">Add to Trip</button>
            </form>
            <div class="mt-3" ng-if="inviteResponse">
                <div class="alert alert-info">{{ inviteResponse }}</div>
            </div>
        </div>
    </div>
    <div class="alert alert-danger mt-4" ng-show="errorMsg">{{ errorMsg }}</div>
</div>
<script>
angular.module('GoLocalApp', [])
.controller('TripDetailController', function($scope, $http) {
    $scope.jwt = localStorage.getItem('jwt');
    var urlParams = new URLSearchParams(window.location.search);
    $scope.tripId = urlParams.get('id');
    $scope.isAdmin = false;
    $scope.trip = {};
    $scope.participants = [];
    $scope.errorMsg = '';
    $scope.inviteEmail = '';
    $scope.inviteResponse = '';
    var apiBase = 'http://api.golocal.test/api/trips/';
    if (!$scope.jwt || !$scope.tripId) {
        $scope.errorMsg = 'Access Denied or invalid trip ID.';
        return;
    }
    $scope.showError = function(message) {
        $scope.errorMsg = message;
        setTimeout(function() { $scope.$apply(function() { $scope.errorMsg = ''; }); }, 2000);
    };
    $scope.fetchTripDetails = function() {
        $http({
            method: 'GET',
            url: apiBase + 'read_single?id=' + $scope.tripId,
            headers: { 'Authorization': 'Bearer ' + $scope.jwt }
        }).then(function(response) {
            $scope.trip = response.data;
            $scope.isAdmin = ($scope.trip.is_admin === true || $scope.trip.is_admin === 1 || $scope.trip.is_admin === '1');
            $scope.adminId = $scope.trip.admin_id;
            $scope.coAdminId = $scope.trip.co_admin_id;
            $scope.fetchParticipants();
        }, function(error) {
            var errorMsg = error.data && error.data.message ? error.data.message : 'Could not load trip details.';
            $scope.showError(errorMsg);
        });
    };
    $scope.fetchParticipants = function() {
        $http({
            method: 'GET',
            url: apiBase + 'read_participants?id=' + $scope.tripId,
            headers: { 'Authorization': 'Bearer ' + $scope.jwt }
        }).then(function(response) {
            $scope.participants = response.data.records || [];
        }, function(error) {
            var errorMsg = error.data && error.data.message ? error.data.message : 'Could not load participants.';
            $scope.showError(errorMsg);
        });
    };
    $scope.makeCoAdmin = function(userId) {
        if (!confirm('Are you sure you want to make this participant the co-admin?')) return;
        $http({
            method: 'POST',
            url: apiBase + 'set_coadmin',
            data: { jwt: $scope.jwt, trip_id: $scope.tripId, user_id: userId },
            headers: { 'Content-Type': 'application/json' }
        }).then(function(response) {
            $scope.showError(response.data.message);
            $scope.fetchTripDetails();
        }, function(error) {
            var errorMsg = error.data && error.data.message ? error.data.message : 'Could not set co-admin.';
            $scope.showError(errorMsg);
        });
    };
    $scope.deleteParticipant = function(participantId) {
        if (!confirm('Are you sure you want to remove this participant?')) return;
        $http({
            method: 'POST',
            url: apiBase + 'delete_participant',
            data: { jwt: $scope.jwt, participant_id: participantId },
            headers: { 'Content-Type': 'application/json' }
        }).then(function(response) {
            $scope.showError(response.data.message);
            $scope.fetchParticipants();
        }, function(error) {
            var errorMsg = error.data && error.data.message ? error.data.message : 'Could not remove participant.';
            $scope.showError(errorMsg);
        });
    };
    $scope.inviteParticipant = function() {
        if (!$scope.inviteEmail) return;
        $http({
            method: 'POST',
            url: apiBase + 'invite',
            data: { jwt: $scope.jwt, trip_id: $scope.tripId, email: $scope.inviteEmail },
            headers: { 'Content-Type': 'application/json' }
        }).then(function(response) {
            $scope.inviteResponse = response.data.message;
            $scope.inviteEmail = '';
            $scope.fetchParticipants();
        }, function(error) {
            var errorMsg = error.data && error.data.message ? error.data.message : 'An error occurred.';
            $scope.inviteResponse = errorMsg;
            $scope.showError(errorMsg);
        });
    };
    $scope.getCurrentUserId = function() {
        try {
            var payload = JSON.parse(atob($scope.jwt.split('.')[1]));
            return payload.data && payload.data.id ? payload.data.id : null;
        } catch (e) { return null; }
    };
    $scope.isAdminUser = function() {
        return $scope.adminId == $scope.getCurrentUserId();
    };
    $scope.canShowMakeCoAdmin = function(participant) {
        return $scope.isAdmin && $scope.isAdminUser() && participant.user_id != $scope.adminId && participant.user_id != $scope.coAdminId;
    };
    $scope.canShowDelete = function(participant) {
        return $scope.isAdmin && participant.user_id != $scope.adminId;
    };
    $scope.getParticipantName = function(participant) {
        return participant.user_name || participant.user_email || (participant.user_id ? 'User ID: ' + participant.user_id : 'Unknown User');
    };
    // Initial load
    $scope.fetchTripDetails();
});
</script>
</body>
</html>